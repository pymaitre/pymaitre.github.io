<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>dcm_anonymize.anonymization &mdash; dcm_anonymize 00.01.00 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            dcm_anonymize
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">dcm_anonymize</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">dcm_anonymize</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">dcm_anonymize.anonymization</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for dcm_anonymize.anonymization</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;anonimization.py:</span>

<span class="sd">Library with functions for anonymization</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">pydicom</span>
<span class="kn">from</span> <span class="nn">pydicom</span> <span class="kn">import</span> <span class="n">dcmread</span>
<span class="kn">import</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">glob2</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">timeit</span> <span class="kn">import</span> <span class="n">default_timer</span> <span class="k">as</span> <span class="n">timer</span>
<span class="kn">import</span> <span class="nn">psutil</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<div class="viewcode-block" id="saveinfo"><a class="viewcode-back" href="../../dcm_anonymize.html#dcm_anonymize.anonymization.saveinfo">[docs]</a><span class="k">def</span> <span class="nf">saveinfo</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">modality</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save informations that are anonymized into a .csv.</span>

<span class="sd">    :param file: single file name (str).</span>
<span class="sd">    :param list: list of keyword to be anonymized inside the .dcm files (str list).</span>
<span class="sd">    :param folder: folder where the file is originally located (str).</span>
<span class="sd">    :param modality: modality of imaging (e.g. CT, MR ...).</span>
<span class="sd">    :return: df: dataframe with all the informations about the single file to be saved into a .csv.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">dcmread</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;This is not a DICOM file!&quot;</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">dcmread</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;Modality&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">modality</span><span class="p">:</span>
        <span class="c1"># if (ds[0x0020, 0x0013].value != None):</span>
        <span class="c1">#     if (int(ds[0x0020, 0x0013].value) == 1): #image number</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">folder</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>  <span class="c1"># [os.path.basename(fileout_path)]</span>
        <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Manufacturer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;Manufacturer&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;ManufacturerModelName&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;ManufacturerModelName&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;XPixelSpacing&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;PixelSpacing&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;YPixelSpacing&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;PixelSpacing&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;SliceThickness&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;SliceThickness&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;NumberProcessedFiles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">glob2</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">file</span><span class="p">),</span> <span class="s2">&quot;*&quot;</span><span class="p">)))</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Folder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">folder</span>
    <span class="c1"># else:</span>
    <span class="c1">#     print(&#39;Alert!! Series without acquisition number, it will be not saved into the .csv&#39;)</span>

    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="modifydsc"><a class="viewcode-back" href="../../dcm_anonymize.html#dcm_anonymize.anonymization.modifydsc">[docs]</a><span class="k">def</span> <span class="nf">modifydsc</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="n">folder</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Anonimize the dicom file. If the file has not the dicom header it will be forced to be read anyway.</span>
<span class="sd">    In place of &#39;PatientName&#39; and &#39;PatientID&#39; it will be written the patient folder ID.</span>

<span class="sd">    :param file: single file name (str).</span>
<span class="sd">    :param list: list of keyword to be anonymized inside the .dcm files (str list).</span>
<span class="sd">    :param folder: folder where the file is originally located (str).</span>
<span class="sd">    :return: ds: dicom file read and modified.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">dcmread</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;This is not a DICOM file!&quot;</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">dcmread</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ll</span> <span class="o">==</span> <span class="s2">&quot;PatientName&quot;</span><span class="p">:</span>
            <span class="n">ds</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">folder</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># os.path.basename(fileout_path)</span>
        <span class="k">elif</span> <span class="n">ll</span> <span class="o">==</span> <span class="s2">&quot;PatientID&quot;</span><span class="p">:</span>  <span class="c1"># &amp; ((ds[ll].value == &#39;&#39;) | (ds[ll].value == None))):</span>
            <span class="n">ds</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">folder</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ds</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="p">[</span><span class="mh">0x0033</span><span class="p">,</span> <span class="mh">0x1013</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ds</span><span class="p">:</span>
        <span class="n">ds</span><span class="p">[</span><span class="mh">0x0033</span><span class="p">,</span> <span class="mh">0x1013</span><span class="p">]</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">folder</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">ds</span></div>


<div class="viewcode-block" id="savedsc"><a class="viewcode-back" href="../../dcm_anonymize.html#dcm_anonymize.anonymization.savedsc">[docs]</a><span class="k">def</span> <span class="nf">savedsc</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">fileout_path</span><span class="p">,</span> <span class="n">ds</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save an anonymized copy of the file in a selected new folder.</span>
<span class="sd">    Checks are applied to reduce the file name (if the characters are too many to be saved)</span>
<span class="sd">    or to add the extension .dcm if the original ones had it implicit.</span>

<span class="sd">    :param ff: single file name (str).</span>
<span class="sd">    :param fileout_path: folder to which the file will be saved (str).</span>
<span class="sd">    :param ds: dicom file modified to be saved.</span>
<span class="sd">    :return: 0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fileout_path</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">fileout_path</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ff</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;dcm&quot;</span><span class="p">:</span>
            <span class="n">ds</span><span class="o">.</span><span class="n">save_as</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fileout_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ff</span><span class="p">)),</span> <span class="n">write_like_original</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ds</span><span class="o">.</span><span class="n">save_as</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fileout_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ff</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;.dcm&quot;</span><span class="p">,</span> <span class="n">write_like_original</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ff</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">55</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ALERT! true name:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ff</span><span class="p">)))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ff</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;dcm&quot;</span><span class="p">:</span>
                    <span class="n">ds</span><span class="o">.</span><span class="n">save_as</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fileout_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ff</span><span class="p">)[</span><span class="o">-</span><span class="mi">55</span><span class="p">:]),</span> <span class="n">write_like_original</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ds</span><span class="o">.</span><span class="n">save_as</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fileout_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ff</span><span class="p">)[</span><span class="o">-</span><span class="mi">55</span><span class="p">:]),</span> <span class="n">write_like_original</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ff</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s2">&quot;dcm&quot;</span><span class="p">:</span>
                    <span class="n">ds</span><span class="o">.</span><span class="n">save_as</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fileout_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ff</span><span class="p">)[</span><span class="o">-</span><span class="mi">52</span><span class="p">:]),</span> <span class="n">write_like_original</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ds</span><span class="o">.</span><span class="n">save_as</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fileout_path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ff</span><span class="p">)[</span><span class="o">-</span><span class="mi">52</span><span class="p">:]),</span> <span class="n">write_like_original</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="add_not_dcm"><a class="viewcode-back" href="../../dcm_anonymize.html#dcm_anonymize.anonymization.add_not_dcm">[docs]</a><span class="k">def</span> <span class="nf">add_not_dcm</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">pathout</span><span class="p">,</span> <span class="n">parent_folder</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add dicom files to the list of files to be anonymized also if they have no extension .dcm.</span>
<span class="sd">    .mim files are excluded and copied in the new destination as they are.</span>

<span class="sd">    :param files: list of file names found with .dcm (str list).</span>
<span class="sd">    :param pathout: path to the folder to which the file will be saved (str).</span>
<span class="sd">    :param parent_folder: folder where data to be anonymized are (str).</span>
<span class="sd">    :return: files: list of file names found (str list).</span>
<span class="sd">    :return: unique_folder: Folders from which files were imported (selected to be unique).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">unique_folder</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;files without .dcm extension: note that they are considered as dicom files&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">unique_folder</span><span class="p">):</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">glob2</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">))</span>
        <span class="n">l1</span> <span class="o">=</span> <span class="n">glob2</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;*.dcm&quot;</span><span class="p">))</span>
        <span class="n">l2</span> <span class="o">=</span> <span class="n">glob2</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;*.mim&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">l2</span><span class="p">:</span>
            <span class="n">fmim</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pathout</span><span class="p">,</span> <span class="n">ll</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">parent_folder</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fmim</span><span class="p">)):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">fmim</span><span class="p">))</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">ll</span><span class="p">,</span> <span class="n">fmim</span><span class="p">)</span>
        <span class="n">list_nodcm</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">l1</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">l2</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">unique_folder</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">list_nodcm</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;folder: &quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">list_nodcm</span><span class="p">)</span>
        <span class="c1"># os.rename(f, f + &#39;.dcm&#39;)</span>

    <span class="k">return</span> <span class="n">files</span><span class="p">,</span> <span class="n">unique_folder</span></div>


<div class="viewcode-block" id="save_control_csv"><a class="viewcode-back" href="../../dcm_anonymize.html#dcm_anonymize.anonymization.save_control_csv">[docs]</a><span class="k">def</span> <span class="nf">save_control_csv</span><span class="p">(</span><span class="n">df_tot</span><span class="p">,</span> <span class="n">unique_folder</span><span class="p">,</span> <span class="n">pathout</span><span class="p">,</span> <span class="n">parent_folder</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save a .csv to controll if the input files and the output anonymized files are of the same number.</span>

<span class="sd">    :param df_tot: dataframe of anonymized files.</span>
<span class="sd">    :param unique_folder: Folders from which files were imported (selected to be unique).</span>
<span class="sd">    :param pathout: path to the folder to which the files will be saved (str).</span>
<span class="sd">    :param parent_folder: folder where data to be anonymized are (str).</span>
<span class="sd">    :param path: path where to save the control file .csv.</span>
<span class="sd">    :return: 0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">## SAVE A .CSV TO CHECK IF THE NUMBER OF FILES IN INPUT ARE THE SAME AS THE ONES IN OUTPUT.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">df_tot</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">df_now</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">df_now</span><span class="p">[</span><span class="s2">&quot;Folder_Path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">unique_folder</span><span class="p">)</span>
        <span class="n">df_now</span><span class="p">[</span><span class="s2">&quot;AnonymizedFolder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pathout</span><span class="p">,</span> <span class="n">ff</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">parent_folder</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span> <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="n">df_now</span><span class="p">[</span><span class="s2">&quot;Folder_Path&quot;</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="n">df_now</span><span class="p">[</span><span class="s2">&quot;NumberAnonymizedFiles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">glob2</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">)))</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">df_now</span><span class="p">[</span><span class="s2">&quot;AnonymizedFolder&quot;</span><span class="p">]]</span>
        <span class="n">df_now</span><span class="p">[</span><span class="s2">&quot;NumberOriginalFiles&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">glob2</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">)))</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">df_now</span><span class="p">[</span><span class="s2">&quot;Folder_Path&quot;</span><span class="p">]]</span>
        <span class="n">df_now_save</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_tot</span><span class="p">,</span> <span class="n">df_now</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Folder_Path&quot;</span><span class="p">)[</span>
            <span class="p">[</span><span class="s2">&quot;Folder_Path&quot;</span><span class="p">,</span> <span class="s2">&quot;NumberProcessedFiles&quot;</span><span class="p">,</span> <span class="s2">&quot;NumberOriginalFiles&quot;</span><span class="p">,</span> <span class="s2">&quot;AnonymizedFolder&quot;</span><span class="p">,</span> <span class="s2">&quot;NumberAnonymizedFiles&quot;</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="n">df_now_save</span><span class="p">[</span><span class="s2">&quot;Difference&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_now_save</span><span class="p">[</span><span class="s2">&quot;NumberOriginalFiles&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_now_save</span><span class="p">[</span><span class="s2">&quot;NumberAnonymizedFiles&quot;</span><span class="p">]</span>
        <span class="n">df_now_save</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;controll_anonymous_&quot;</span> <span class="o">+</span> <span class="n">parent_folder</span> <span class="o">+</span> <span class="s2">&quot;.csv&quot;</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
        <span class="c1">#print(&#39;Difference between original and anonymized: &#39;,  max(df_now_save[&#39;Difference&#39;]))</span>

    <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="save_info_csv"><a class="viewcode-back" href="../../dcm_anonymize.html#dcm_anonymize.anonymization.save_info_csv">[docs]</a><span class="k">def</span> <span class="nf">save_info_csv</span><span class="p">(</span><span class="n">df_tot</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">list_fields</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">parent_folder</span><span class="p">,</span> <span class="n">modality</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save a .csv of the data anonymized inside the files (one for folder).</span>

<span class="sd">    :param df_tot: dataframe of anonymized files with specific informations.</span>
<span class="sd">    :param file: file name to be saved and added to the .csv.</span>
<span class="sd">    :param list_fields: list of keyword to be anonymized inside the .dcm files (str list).</span>
<span class="sd">    :param folder: folder where the file is originally located (str).</span>
<span class="sd">    :param path: path where to save the control file .csv.</span>
<span class="sd">    :param parent_folder: folder where data to be anonymized are (str).</span>
<span class="sd">    :param modality: modality of images e.g., &#39;CT&#39;.</span>
<span class="sd">    :return: df_tot: dataframe of anonymized files with specific informations (added a new line).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">df_tot</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">saveinfo</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">list_fields</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">modality</span><span class="p">)</span>
        <span class="n">df_tot</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_tot</span><span class="p">,</span> <span class="n">df</span><span class="p">])</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">df_tot</span><span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">folder</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">saveinfo</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">list_fields</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">modality</span><span class="p">)</span>
        <span class="n">df_tot</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_tot</span><span class="p">,</span> <span class="n">df</span><span class="p">])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">df_tot</span><span class="o">.</span><span class="n">empty</span><span class="p">):</span>
        <span class="n">df_tot</span><span class="p">[</span><span class="s2">&quot;Folder_Path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">parent_folder</span><span class="p">,</span> <span class="n">df_tot</span><span class="p">[</span><span class="s2">&quot;Folder&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">df_tot</span></div>


<div class="viewcode-block" id="check_RSRPRD"><a class="viewcode-back" href="../../dcm_anonymize.html#dcm_anonymize.anonymization.check_RSRPRD">[docs]</a><span class="k">def</span> <span class="nf">check_RSRPRD</span><span class="p">(</span><span class="n">parent_folder</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check the number of structures, doses and plans for each patient and save an excel for it.</span>

<span class="sd">    :param parent_folder: folder where data to be anonymized are (str).</span>
<span class="sd">    :param path: path where to save the control file .csv.</span>
<span class="sd">    :return: df: Dataframe with informations saved (pd.DataFrame).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))),</span> <span class="s2">&quot;wrk&quot;</span><span class="p">)</span>
    <span class="n">folder</span> <span class="o">=</span> <span class="n">glob2</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">parent_folder</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">))</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Npaziente&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ff</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="n">folder</span><span class="p">]</span>
    <span class="n">ntac</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span> <span class="n">rd</span><span class="p">,</span> <span class="n">check</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">folder</span><span class="p">:</span>
        <span class="n">filesCT</span> <span class="o">=</span> <span class="n">glob2</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;**&quot;</span><span class="p">,</span> <span class="s2">&quot;*.dcm&quot;</span><span class="p">))</span>
        <span class="n">filesRS</span> <span class="o">=</span> <span class="n">glob2</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;**&quot;</span><span class="p">,</span> <span class="s2">&quot;*RS*.dcm&quot;</span><span class="p">))</span>
        <span class="n">filesRP</span> <span class="o">=</span> <span class="n">glob2</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;**&quot;</span><span class="p">,</span> <span class="s2">&quot;*RP*.dcm&quot;</span><span class="p">))</span>
        <span class="n">filesRD</span> <span class="o">=</span> <span class="n">glob2</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;**&quot;</span><span class="p">,</span> <span class="s2">&quot;*RD*.dcm&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filesRS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;**&quot;</span><span class="p">,</span> <span class="s2">&quot;*rts*.dcm&quot;</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;**&quot;</span><span class="p">,</span> <span class="s2">&quot;*RTst*&quot;</span><span class="p">,</span> <span class="s2">&quot;*.dcm&quot;</span><span class="p">)]:</span>
                <span class="n">filesRS</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">glob2</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filesRP</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;**&quot;</span><span class="p">,</span> <span class="s2">&quot;*rtp*.dcm&quot;</span><span class="p">),</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;**&quot;</span><span class="p">,</span> <span class="s2">&quot;*RTP*&quot;</span><span class="p">,</span> <span class="s2">&quot;*.dcm&quot;</span><span class="p">),</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;**&quot;</span><span class="p">,</span> <span class="s2">&quot;*RP*&quot;</span><span class="p">,</span> <span class="s2">&quot;*.dcm&quot;</span><span class="p">),</span>
            <span class="p">]:</span>
                <span class="n">filesRP</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">glob2</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filesRD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;**&quot;</span><span class="p">,</span> <span class="s2">&quot;*rtd*.dcm&quot;</span><span class="p">),</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;**&quot;</span><span class="p">,</span> <span class="s2">&quot;*RD*&quot;</span><span class="p">,</span> <span class="s2">&quot;*.dcm&quot;</span><span class="p">),</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;**&quot;</span><span class="p">,</span> <span class="s2">&quot;*RTDOSE*&quot;</span><span class="p">,</span> <span class="s2">&quot;*.dcm&quot;</span><span class="p">),</span>
            <span class="p">]:</span>
                <span class="n">filesRD</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">glob2</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="n">rs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filesRS</span><span class="p">))</span>
        <span class="n">rp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filesRP</span><span class="p">))</span>
        <span class="n">rd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filesRD</span><span class="p">))</span>
        <span class="n">ntac</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filesCT</span><span class="p">)</span> <span class="o">-</span> <span class="n">rs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">rp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">rd</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ntac</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">rs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">rp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">rd</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">check</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">check</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;N_tac&quot;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;N_rs&quot;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;N_rp&quot;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;N_rd&quot;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;check&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ntac</span><span class="p">,</span> <span class="n">rs</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span> <span class="n">rd</span><span class="p">,</span> <span class="n">check</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;N_rs&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;N_rp&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;N_rd&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;N_rs&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;N_rp&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;N_rd&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">ind_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">folder</span><span class="p">)[</span><span class="n">ind_s</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">ind_s</span><span class="p">),</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;N_rs&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;N_rp&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;N_rd&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;All is correct!&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;N_rs&quot;</span><span class="p">]),</span> <span class="nb">min</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;N_rp&quot;</span><span class="p">]),</span> <span class="nb">min</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;N_rd&quot;</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="simple_anonymize"><a class="viewcode-back" href="../../dcm_anonymize.html#dcm_anonymize.anonymization.simple_anonymize">[docs]</a><span class="k">def</span> <span class="nf">simple_anonymize</span><span class="p">(</span><span class="n">folderOR</span><span class="p">,</span> <span class="n">parent_folder</span><span class="p">,</span> <span class="n">list_fields</span><span class="p">,</span> <span class="n">unique_folder</span><span class="p">,</span> <span class="n">pathout</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">modality</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Anonymize dicom files inside a specific folder. For this it is needed to be known the folder&#39;s name.</span>

<span class="sd">    :param folderOR: specific folder to be considered (str).</span>
<span class="sd">    :param parent_folder: folder where data to be anonymized are (str).</span>
<span class="sd">    :param list_fields: list of keyword to be anonymized inside the .dcm files (str list).</span>
<span class="sd">    :param unique_folder: Folders from which files were imported (selected to be unique).</span>
<span class="sd">    :param pathout: path to be considered for saving (str).</span>
<span class="sd">    :param path: path to be considered for reading (str).</span>
<span class="sd">    :param modality: modality of images e.g., &#39;CT&#39;.</span>
<span class="sd">    :return: 0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">glob2</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">folderOR</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">**</span><span class="se">\\</span><span class="s2">*.dcm&quot;</span><span class="p">)</span>
    <span class="n">df_tot</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">ff</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent_folder</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">fileout_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pathout</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
        <span class="n">df_tot</span> <span class="o">=</span> <span class="n">save_info_csv</span><span class="p">(</span><span class="n">df_tot</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">list_fields</span><span class="p">,</span> <span class="n">folder</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">parent_folder</span><span class="p">,</span> <span class="n">modality</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">modifydsc</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">list_fields</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>
        <span class="n">savedsc</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">fileout_path</span><span class="p">,</span> <span class="n">ds</span><span class="p">)</span>
    <span class="c1"># df_tot = df_tot.reset_index(drop=True)</span>
    <span class="c1"># df_tot.index.name = &#39;index&#39;</span>
    <span class="c1"># df_tot.to_csv(os.path.join(path, &#39;database_anonymous_&#39; + parent_folder + &#39;.csv&#39;), sep=&#39;;&#39;)</span>
    <span class="c1"># save_control_csv(df_tot, unique_folder, pathout, parent_folder, path)</span>

    <span class="k">return</span> <span class="n">df_tot</span></div>


<div class="viewcode-block" id="anonymize"><a class="viewcode-back" href="../../dcm_anonymize.html#dcm_anonymize.anonymization.anonymize">[docs]</a><span class="k">def</span> <span class="nf">anonymize</span><span class="p">(</span><span class="n">parent_folder</span><span class="p">,</span> <span class="n">modality</span><span class="p">,</span> <span class="n">list_fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mim</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    anonymize all the dicom files inside a specific folder.</span>
<span class="sd">    Note: if none of the files are .dcm in a single folder, one of them have to be modified previously.</span>
<span class="sd">    For this it is needed to be known the folder&#39;s name.</span>

<span class="sd">    :param parent_folder: folder where data to be anonymized are (str).</span>
<span class="sd">    :param modality: modality of images e.g., &#39;CT&#39;.</span>
<span class="sd">    :param list_fields: list of keyword to be anonymized inside the .dcm files (str list).</span>
<span class="sd">    :param path: path to be considered for reading and saving (str).</span>
<span class="sd">    :param parallel: True if parallelization is used (bool).</span>
<span class="sd">    :param mim: if the analysis is done for MIM software or not.</span>
<span class="sd">    :return: 0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;wrk&quot;</span> <span class="o">/</span> <span class="n">parent_folder</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;**/*.dcm&quot;</span><span class="p">)</span>
        <span class="n">pathout</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;wrk&quot;</span><span class="p">,</span> <span class="s2">&quot;ANONYMIZED_&quot;</span> <span class="o">+</span> <span class="n">parent_folder</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">((</span><span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">/</span> <span class="n">parent_folder</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;**/*.dcm&quot;</span><span class="p">))</span>
        <span class="n">pathout</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;ANONYMIZED_&quot;</span> <span class="o">+</span> <span class="n">parent_folder</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">list_fields</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">list_fields</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;PatientName&quot;</span><span class="p">,</span>
            <span class="s2">&quot;PatientBirthDate&quot;</span><span class="p">,</span>
            <span class="s2">&quot;AccessionNumber&quot;</span><span class="p">,</span>
            <span class="s2">&quot;StudyTime&quot;</span><span class="p">,</span>
            <span class="s2">&quot;PatientID&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ReferringPhysicianName&quot;</span><span class="p">,</span>
        <span class="p">]</span>  <span class="c1"># , &#39;Physician(s)Record&#39;</span>
    <span class="c1">## READ .csv</span>
    <span class="c1"># files_csv = glob.glob(os.path.join(path, &#39;wrk&#39;, &#39;data&#39;, &#39;*.csv&#39;))</span>
    <span class="c1"># dataset = pd.read_csv(files_csv[0], encoding=&#39;latin1&#39;)</span>
    <span class="c1">## IF FILES NOT WITH THE RIGHT EXTENSION .dcm or they are .mim</span>
    <span class="c1"># TODO: generalize if there is none .dcm in the folder - now done manually before for one of them</span>
    <span class="n">files</span><span class="p">,</span> <span class="n">unique_folder</span> <span class="o">=</span> <span class="n">add_not_dcm</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">pathout</span><span class="p">,</span> <span class="n">parent_folder</span><span class="p">)</span>
    <span class="n">df_tot</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">unique_folder</span><span class="p">))</span>
    <span class="c1"># print([x.split(os.path.join(parent_folder,&#39;&#39;))[1] for x in files])</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;GLOBAL&quot;</span><span class="p">,</span> <span class="n">colour</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;wrk&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">parallel</span><span class="p">:</span>
        <span class="n">df_tot</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">cpu_number</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">psutil</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">(</span><span class="n">logical</span><span class="o">=</span><span class="kc">False</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">cpu_number</span><span class="p">)</span> <span class="k">as</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">imap</span><span class="p">(</span>
                <span class="n">partial</span><span class="p">(</span>
                    <span class="n">simple_anonymize</span><span class="p">,</span>
                    <span class="n">parent_folder</span><span class="o">=</span><span class="n">parent_folder</span><span class="p">,</span>
                    <span class="n">list_fields</span><span class="o">=</span><span class="n">list_fields</span><span class="p">,</span>
                    <span class="n">unique_folder</span><span class="o">=</span><span class="n">unique_folder</span><span class="p">,</span>
                    <span class="n">pathout</span><span class="o">=</span><span class="n">pathout</span><span class="p">,</span>
                    <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
                    <span class="n">modality</span><span class="o">=</span><span class="n">modality</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="nb">sorted</span><span class="p">(</span><span class="n">unique_folder</span><span class="p">),</span>
            <span class="p">):</span>
                <span class="n">df_tot</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_tot</span><span class="p">,</span> <span class="n">result</span><span class="p">]))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">df_tot</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;index&quot;</span>
                <span class="n">df_tot</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;database_anonymous_&quot;</span> <span class="o">+</span> <span class="n">parent_folder</span> <span class="o">+</span> <span class="s2">&quot;.csv&quot;</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
                <span class="n">save_control_csv</span><span class="p">(</span><span class="n">df_tot</span><span class="p">,</span> <span class="n">unique_folder</span><span class="p">,</span> <span class="n">pathout</span><span class="p">,</span> <span class="n">parent_folder</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">ff</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">unique_folder</span><span class="p">):</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">simple_anonymize</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">parent_folder</span><span class="p">,</span> <span class="n">list_fields</span><span class="p">,</span> <span class="n">unique_folder</span><span class="p">,</span> <span class="n">pathout</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">modality</span><span class="p">)</span>
            <span class="n">df_tot</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_tot</span><span class="p">,</span> <span class="n">df</span><span class="p">]))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df_tot</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;index&quot;</span>
            <span class="n">df_tot</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;database_anonymous_&quot;</span> <span class="o">+</span> <span class="n">parent_folder</span> <span class="o">+</span> <span class="s2">&quot;.csv&quot;</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
            <span class="n">save_control_csv</span><span class="p">(</span><span class="n">df_tot</span><span class="p">,</span> <span class="n">unique_folder</span><span class="p">,</span> <span class="n">pathout</span><span class="p">,</span> <span class="n">parent_folder</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;done: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ff</span><span class="p">))</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">timer</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;elapsed time: </span><span class="si">{</span><span class="p">(</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="si">}</span><span class="s2"> min&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="compare_database"><a class="viewcode-back" href="../../dcm_anonymize.html#dcm_anonymize.anonymization.compare_database">[docs]</a><span class="k">def</span> <span class="nf">compare_database</span><span class="p">(</span><span class="n">parent_folder</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Database comparison to check if all data where copied correctly.</span>

<span class="sd">    :param parent_folder: folder where data to be anonymized are (str).</span>
<span class="sd">    :param file_name: name of excel where the anonymized files are listed (str).</span>
<span class="sd">    :param path: path where the excel is stored (str).</span>
<span class="sd">    :return: 0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">files_csv</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">))</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">files_csv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;latin1&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">check_RSRPRD</span><span class="p">(</span><span class="n">parent_folder</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="n">df_tot</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;Npaziente&quot;</span><span class="p">)</span>
    <span class="n">df_tot</span> <span class="o">=</span> <span class="n">df_tot</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;Npaziente&quot;</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_tot</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;RSRPRD_&quot;</span> <span class="o">+</span> <span class="n">parent_folder</span> <span class="o">+</span> <span class="s2">&quot;.csv&quot;</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="mi">0</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, M.G. Ubeira-Gabellini, G. Palazzo.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>